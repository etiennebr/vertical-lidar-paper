---
title: "Species, Crown Cover, and Age as Determinants of the Vertical Distribution of Airborne LiDAR Returns"
author: "Etienne Racine^1,\\*^, Nicholas C. Coops^2^, Jean Bégin^1^, Mari Myllymäki^3^"
date: "^1^:Département des sciences du bois et de la forêt, 2405 rue de la Terrasse, Université Laval, Québec, QC G1V 0A6, Canada; ^2^:Department of Forest Resources Management, 2424 Main Mall, University of British Columbia, Vancouver, BC V6T 1Z4, Canada; ^3^:Natural Resources Institute Finland (Luke), Latokartanonkaari 9, FI-00790 Helsinki, Finland"
output:
  bookdown::pdf_document2: 
    latex_engine: pdflatex
    keep_tex: true
    keep_md: true
    toc: false
    includes:
      in_header: "preamble.tex"
  bookdown::word_document2:
    reference_docx: "templates/StylesTemplate.docx"
    keep_md: true
    fig_width: 7
    fig_height: 7
    fig_caption: true
    device: png
    number_sections: false
  bookdown::html_document2:
    df_print: pagedfarra
    number_sections: false
    section_divs: false
    keep_md: true
    numbering: false
csl: "templates/trees.csl"
#bibliography: "`r rbbt::bbt_write_bib('biblio.json', overwrite = TRUE)`"
bibliography: "biblio.json"
link-citations: yes
always_allow_html: true
---

```{r setup, include = FALSE}
library(knitr)
library(kableExtra)

is_docx_output <- function(x) {
  isTRUE(knitr::opts_knit$get('rmarkdown.pandoc.to') == "docx")
}

include <- function(fig, path = "figure", device = ifelse(is_docx_output(), "png", "svg")) {
  knitr::include_graphics(file.path(path, paste0(fig, ".", device)))
}

# sanitize captions
cap <- function(x) {
  # remove newlines from captions
  gsub("\\n", " ", x) %>%
  gsub("\\s\\s+", " ", .) %>%
  # escape percent
  gsub("([^\\\\])%", "\\1\\\\%", .) %>% 
  gsub("\\\\@ref", "@ref", .)
}

# Source for the figures
# Make sure this is run before: `knitr::knit(here::here("vignettes/contrasts.Rmd"))`
```

```{r, include=FALSE}
options(tinytex.verbose = FALSE)
knitr::opts_chunk$set(comment = "", out.width = "100%", echo = "FALSE")
```

```{r eval=!knitr::is_latex_output(), echo = FALSE, output = "asis"}
insert_asis <- function(...) knitr::asis_output(paste(..., "", sep = "\n"))
insert_asis("
<details>

<summary>Author information</summary>

Etienne B. Racine\\*<br>
ORCID : 0000-0003-1109-894X<br>
Département des sciences du bois et de la forêt<br>
2405 rue de la Terrasse, Université Laval, Québec, QC G1V 0A6, Canada<br>
etienne.bellemare-racine.1@ulaval.ca

Nicholas C. Coops<br>
ORCID : 0000-0002-0151-9037<br>
Department of Forest Resources Management<br>
2424 Main Mall, University of British Columbia, Vancouver, BC V6T 1Z4, Canada<br>
nicholas.coops@ubc.ca

Jean Bégin<br>
ORCID : 0000-0002-9595-6632<br>
Département des sciences du bois et de la forêt<br>
2405 rue de la Terrasse, Université Laval, Québec, QC G1V 0A6, Canada<br>
jean.begin@sbf.ulaval.ca

Mari Myllymäki<br>
ORCID : 0000-0002-2713-7088<br>
Natural Resources Institute Finland (Luke)<br>
Latokartanonkaari 9, FI-00790 Helsinki, Finland<br>
mari.myllymaki@luke.fi

(\\*) Corresponding Author
</details>
")
```

Keywords: Boreal forest; LiDAR remote sensing; Tree Species; Functional
data analysis; Stand structure.

Key Message {-}
===========
<!-- Should be no more than 30 words -->
We assess even-aged stands vertical distributions of LiDAR returns and find
that species, age, and crown cover each have a distinct pattern that explain
up to 47% of the variations.

Abstract {-}
========
<!-- Please provide an abstract of 150 to 250 words -->
Tree species have different shapes and forest stand dynamics. Light detection
and ranging (LiDAR) can measure the three dimensional position of
reflective material by sending laser pulses through the canopy. We examined the 
influence of three forest stand attributes:
species, crown cover, and age on the vertical distribution of aerial
LiDAR returns of forested stands. We studied over five thousand regular,
even-aged stands in Quebec (Canada) with five dominant species: balsam
fir (*Abies balsamea* (L.) Mill.), paper birch (*Betula papyrifera*
Marsh), black spruce (*Picea mariana* (Mill.) BSP), white spruce (*Picea glauca* 
Moench) and aspen (*Populus tremuloides* Michx.). We modeled vertical distribution of LiDAR 
returns against the three attributes using a functional glm and a novel nonparametric graphical test of significance.
Results indicate that aspen stands had the most uniform vertical distribution of LiDAR returns; balsam fir and
white birch distributions were similar and centered around 50% of the
stand height; black spruce and white spruce distributions were
skewed below 30% of stand height ($p$<0.001). An increase in crown cover
concentrated the distributions around 50% height. Increasing age
gradually shifted the distributions higher in the stand until 50–70
years, where it plateaued and slowly declined at 90–120 years. The full model maximal R²
was 0.47 around 10% of stand height. Results suggest that the stands
vertical distributions of LiDAR returns depend on the three variables studied.
This understanding can be used for stand-level species classification and to study 
the evolution of the forest structure over changing conditions.

# Introduction

The distribution of vegetation material within canopies varies with tree
allometry and competition strategies, leading to variations in canopy
structure and ultimately in environmental conditions
[@pretzsch_dieler12; @purves_etal07; @thorpe_etal10]. Species‑specific canopy 
structures create different
microhabitats, light conditions, and microclimates which in turn
influence rates at which stands sequester carbon. Species have different
carbon allocation strategies that evolve during the growth season
relative to above and below ground carbon allocation such as growing
fruits, deploying leaves, or root access to nutrients and water
[@depury_farquhar97; @lacointe00; @stark_etal12]. These growth and allocation
strategies result in the distinct species-specific tree shapes.

Traditionally, characterization of stand vertical distribution of aboveground 
biomass required either on-site estimation of biomass per vertical layer
often using destructive measurements, scafolding, or tree climbing,
that are time-consuming and limited to small areas [@macarthur_horn69;
@aber79; @bassow_bazzaz97; @tackenberg07].


<!-- ## Forest remote sensing -->

The increasing availability of data collected remotely from airborne,
spaceborne and terrestrial sensors has improved our understanding of the
forest dynamics [@wulder_etal12; @white_etal13; @beland_etal19]. 
Among these sensors, light detection and ranging
(LiDAR) has the ability to penetrate the canopy and provide information
on the spatial location of reflective material. LiDAR is increasingly
used to perform both extensive and highly detailed imaging of the
forest. It uses a laser whose location and orientation are precisely
known to record a 3D scene. A discrete LiDAR pulse is reflected back to the 
sensor by the vegetation as it penetrates the canopy. The sensor then records 
the total travel time of the pulse and its energy to deduce the distance from the
sensor to the location of reflection. LiDAR can be used from the ground, and from
an aircraft to provide different perspectives on the forest. Terrestrial LiDAR
provides highly detailed structural information of individual trees, but its
extent is limited to hundreds of meters [@beland_etal19;
@crespo-peremarch_etal20]. Airborne LiDAR, on the other hand, is generally used
for extensive landscape measurements that are generally less detailed than
terrestrial LiDAR.

Airborne LiDAR has been used to characterize vertical canopy structure, crown
shape, and ecosystem's aboveground biomass [@ellsworth_reich93;
@harding_etal01; @lefsky_etal02; @parker_etal04; @coops_etal07; @stark_etal12;
@cao_etal14; @papa_etal20], to identify tree species [@heinzel_koch11;
@heinzel_koch12; @vaughn_etal12; @hovi_etal16; @fassnacht_etal16; @budei_etal18;
@axelsson_etal18; @fedrigo_etal18], and to study stand characteristics such as
age, crown cover, and basal area [@korhonen_etal11; @white_etal13;
@racine_etal14]. Airborne LiDAR is an important tool to quantify biomass and
offers many opportunities to explore large-scale phenomena that could only be
observed on the field, such as large-scale habitat characterization
[@vierling_etal08; @vierling_etal10; @seavy_etal09].

One of the limitations of the small footprint LiDAR sensor is its inability to
distinguish differences in foliage condition or species spectral variations
because it lacks spectral information commonly used to classify species such as
variations in color or near-infrared. In response, the most common strategy to
distinguish species with LiDAR has been to rely on individual tree shapes and
texture [@holmgren_persson04; @kim_etal11; @fassnacht_etal16], add spectral
information by supplementing it with spectral imagery, and more recently using a
multispectral LiDAR [@budei_etal18; @budei_st-onge18].

<!-- ## Individual tree-crown vs area-based methods -->

Most studies on species classification using aerial LiDAR have focused on
individual tree-crown species identification. Tree crown delineation requires a
high number of LiDAR returns and very accurate registration of ground
observations [@orka_etal09; @muss_etal11]. Furthermore, a small observation area 
such as an individual tree crown loses the shape of the vertical distribution of
LiDAR returns because the number of LiDAR returns decreases and the distribution
increasingly becomes a collection of random deviates. For that reason, species 
identification accuracy is improved by having a very high point density in 
excess of 10 pt/m² [@fassnacht_etal16] making it difficult to apply and validate 
these approaches over large areas, and on a less dense LiDAR datasets.

An alternative to individual tree-crown extraction approaches is the application of
area-based approaches (see e.g. @white_etal13). This approach generally uses a pixel or a stand on
which LiDAR returns are aggregated and from which predictors are derived and
then used in a model to predict forest attributes. LiDAR metrics often derive
predictors from the vertical distribution of LiDAR returns: the number or LiDAR
returns per height slice. The vertical distribution of LiDAR returns is often
presented as quantiles, projections of quantiles (such as principal component
analysis), or parametric functions (such as a Fourier, beta or Weibull
functions), which are used to predict stand attributes [@magnussen_etal99;
@maltamo_etal05; @mehtatalo06; @coops_etal07; @riggins_etal09; @falkowski_etal09; 
@racine_etal14; @palace_etal15]. The area-based method can be effective with
point density as low as 1 pt/m², which reduces cost and processing compared to
tree-crown approaches [@white_etal13].

Lowering the minimum LiDAR point density threshold for species classification
would increase the number of potential surveys where the method could be applied
while reducing the costs of acquisition. The species information could then be used for
extensive forest management, or landscape-scale studies. One avenue to
area-based species mapping is to increase our understanding of the interaction
between LiDAR and stand-level vegetation. The vertical distribution of LiDAR
returns is complex to analyze without resorting to dimension reduction, a method
that generally limits the interpretability of results. We hypothesize that using
functional general linear models (GLM) and a novel non-parametric graphical
test of significance [@mrkvicka_etal19] would allow to link the forest
attributes to the vertical distribution from low-density LiDAR surveys. The test
provides a framework to compare a function (i.e. the vertical distribution of
LiDAR returns) against categorical and continuous variables. It allows for a
visual understanding of the effects of the variables on the functional data.

<!-- ## Forest vertical structure determinants -->

The information contained in the vertical distribution of LiDAR returns is
closely related to the distribution of the vegetation. Reduced crown cover (the
proportion of area covered by vegetation, @gonsamo_etal13) generally allows for an increased
probability for the LiDAR returns to reach lower vegetation [@hilker_etal10].
In turn, age influences the vertical position of the crown within the stand
[@coops_etal09; @racine_etal14]. While using direct foliage measurements,
@aber79 observed that the vertical concentration of the foliage evolved across
stand age, and that the end point of the forest succession seemed to reach an
equilibrium where the foliage was relatively evenly distributed within the
canopy. @martin-ducup_etal16 noted that crown cover and stand 
maturity affected the shapes of the crown of sugar maples as measured using 
terrestrial LiDAR. 

Species shapes influence the distribution of LiDAR
returns, but most studies interpretations are limited and hard to generalize 
across ecosystems or LiDAR surveys [@fassnacht_etal16]. Some studies
explicitly compared the vertical distribution of LiDAR returns between species.
For example, @orka_etal09 found that the first and last returns were more
dispersed in Birch (*Betula* spp.) stands than in Norway spruce (*Picea abies*
(L.) Karst.), which also had a vertical distribution of first returns skewed
toward the superior canopy, and that increased stand height modified the overall
return distribution. To our knowledge, it is the first time that a functional GLM 
combined to a non-parametric graphical test of significance is used in ecology
or remote sensing, although similar graphical tests have been applied to 
economical data (Mrkvička et al. 2020), and similar non-parametric inference is
commonly used in neuroimaging (Winkler et al., 2014).

<!-- ## Objectives -->

In this study we verify if we can discriminate distinct patterns
between species in the vertical distribution of LiDAR returns from a low-density
area-based survey. We hypothesize that the use of a functional GLM combined to a
non-parametric graphical 
test of significance makes it possible to verify inter-specific
differences in the vertical distribution patterns
after accounting for stand crown cover and age effects. 

# Method

## Study area

The study was conducted in Matane Wildlife Reserve (Quebec, Canada,
48°41’N, 66°58’W) covering 1600 km² (Figure \@ref(fig:fig-loc)). The Reserve is a mixed
forest mostly dominated by balsam fir (*Abies balsamea* (L.) Mill.),
paper birch (*Betula papyrifera* Marsh), and black spruce (*Picea
mariana* (Mill.) BSP), but other species are present such as white
spruce (*Picea glauca* Moench), aspen (*Populus tremuloides *Michx.),
Norway spruce (*Picea abies* (L.) Karst.), jack pine (*Pinus banksiana*
Lamb.), and other non-commercial deciduous species. Most of the Reserve is
under active commercial logging, which was documented since 1962: 27% of
the area had been harvested (mostly total harvesting) of which half of
the areas had been replanted. Other natural origins (e.g. windthrow,
insect epidemic, fire) accounted for 2% of the territory and the
remaining 71% of the territory had an undocumented origin. 

```{r include = FALSE}
fig_loc_caption <- 
"Location of Matane Wildlife Reserve (left
panel) and selected stands within the study area (right panel, dark
patches)."
fig_loc_short_caption <- "Location of Matane Wildlife Reserve and selected stands."
```

```{r fig-loc, fig.cap=cap(fig_loc_caption), fig.scap=fig_loc_short_caption, echo = FALSE}
# if (!file.exists("pictures/fig-location.png")) {
#   # adapted from https://github.com/rstudio/bookdown/issues/538#issuecomment-408133271 
#   merge_pngs <- function(imgs, ncol = length(imgs), bottom_text = NULL){
#     f <- function(x) grid::rasterGrob(as.raster(png::readPNG(x)), interpolate = FALSE)
#     grob_list <- lapply(imgs, f)
#     gridExtra::grid.arrange(grobs = grob_list, ncol = 2, bottom = bottom_text)
#   }
#   merge_pngs(c("pictures/rfm.png", "pictures/location_2.png"))
# }
include("fig-location", "pictures", device = "png")
```

Data
----

Airborne imagery and LiDAR were acquired during the summer of 2007. All
data were collected by the Quebec Ministry of Natural Resources as part
of their decennial forest mapping program. LiDAR survey had a nominal
point density of 3 points/m² with an Optech ALTM 2050 sensor recording
first and last returns at 40kHz, flown at 1200 m above ground, with a
flight overlap of 30% and maximal scan angle of 15° from nadir with a
footprint diameter of 25 cm.

Airborne photography was acquired with a Leica ADS–40 pushbroom camera
at a resolution of 0.2 m for panchromatic, and 0.5 m near-infrared, green,
and blue bands (NIR, G, B respectively centered on 860, 560, and 460 nm);
side overlap was 40% to ensure complete coverage of the area. This
imagery was interpreted into stands following provincial guidelines adapted from 
@mrnq07 by expert photo-interpreters. Using digital
stereopsis (virtual 3D vision) from the forward and
nadir-facing ADS–40 sensor images, the expert photo-interpreter classified
many species by integrating information on landscape position, crown
shapes, texture, and color. Every photo was segmented into homogenous
stands using species, crown cover, height, and geomorphic criteria.
Each stand was classified regarding species composition, crown cover,
age, height, and other ecological variables using a combination of
photography, ground-control points and historical data as a reference.
Stand age is estimated using ground control plots where trees were
cored, this information is then combined with available archives, height,
and ecology to judge age from aerial photography. Forest age is
interpreted in 7 regular: (10 [0–20], 30 [21–40], 50
[41–60], 70 [61–80], 90 [81–100], 120 [101, ∞]), and irregular age classes.
Crown cover is visually estimated by comparing the proportion of open
ground with the space occupied by the mature tree crowns. It is
estimated in 9 classes: 10 [5–14], 20 [15–24], 30 [25–34], 40
[35–44], 50 [45–54], 60 [55–64], 70 [65–74], 80 [75–84], and
90 [85–100]. Species are identified by their distinctive spectral
response based on composite near-infrared image, green and blue
(NIR+G+B) images respectively mapped to red, green, and blue (R, G, B)
channels, and their frequent associations in forest stands (Table \@ref(tab:species)).
Finally, the interpretation relied on the ground-control points and the
ecological knowledge of the photo-interpreter. We used this photo-interpreted forest map 
as our reference data for species, crown cover, and age.

```{r species, echo = FALSE}
x <- tibble::tribble(
    ~Species, ~Silhouette, ~"Interpretation description\\textsuperscript{1, 2}", ~"Associated species\\textsuperscript{1}",
    
    "*Abies balsamea*", 
    "![](pictures/abies_balsamea.png){width='1.469cm' height='4.001cm'}", 
    "Mesic sites. Narrow conic crown with a sharp and thin summit that is frequently pale because of the accumulated cones that are more reflective than foliage. Brown, slightly pink tint, browner and pinker than white spruce.", 
    "Trembling aspen, white birch, white spruce, black spruce, red spruce, and eastern hemlock.",
    
    "*Betula papyrifera*", 
    "![](pictures/betula_papyrifera.png){width='1.951cm' height='4.034cm'}", 
    "Multiple conditions but avoids poorly drained sites. Shaped as a flat half-sphere. Crowns are also highly mingled and present an irregular texture that makes them hard to identify individually even at higher resolutions. Dark pink tint between yellow birch and maples.", 
    "Various species such as other birches, pines, spruces, hemlocks, poplars, maples, balsam fir, northern red oak, and pin cherry.",
    
    "*Picea mariana*", 
    "![](pictures/picea_mariana.png){width='1.041cm' height='4.001cm'}", 
    "On poorly drained sites, crown thin and narrow, spirelike, sharp summit with compact foliage. On well-drained upland sites, principal branches short compared with other spruces, lower ones greatly drooping, tips upturned. Upper part of the crown often very dense, oddly shaped, with many cones. Brown, slightly pink when young, paler than white spruce.", "In the southern part of its range, tamarack. Northern part: jack pine, white spruce, balsam fir, white birch, trembling aspen.",
    
    "*Picea glauca*", 
    "![](pictures/picea_glauca.png){width='1.469cm' height='4.001cm'}", 
    "Well to moderately drained sites in mid slopes. Broad conical crown, appears star shaped, ragged, irregular, densely foliated, spirelike in northern parts of its range.  Principal branches bushy, generally horizontal, sometimes sloping downward in the lower part of the crown, tips gradually upturned. Brown, slightly pink when young, darker than black spruces.", 
    "Trembling aspen, white birch, black spruce, and balsam fir.",
    
    "*Populus tremuloides*", 
    "![](pictures/populus_tremuloides.png){width='1.191cm' height='4.001cm'}", 
    "All sites except poorly drained. Short, rounded, light bulb-shaped crown usually taller than surroundings when mixed. Crown surface looks blurred and smooth because of the small leaves. Orange-tinted pink.",
    "White spruce, black spruce, balsam fir, white birch, balsam poplar and jack pine")

tbl_species <- x %>% 
  dplyr::mutate(
    Species = stringr::str_replace_all(Species, "\\*", ""),
    Silhouette = stringr::str_extract(Silhouette, "([^\\)\\(!\\[\\])]+)"),
    #Silhouette = here::here(Silhouette),
    #Silhouette = sprintf('\\includegraphics[valign=T,scale=0.4]{%s}', Silhouette)
    Silhouette = sprintf('\\includegraphics[valign=T,scale=0.5,raise=2mm]{%s}', Silhouette)
    #Silhouette = sprintf('\\begin{minipage}\\includegraphics[valign=T,scale=0.4]{%s}\\end{minipage}', Silhouette)
    #Silhouette = sprintf('\\raisebox{-.8\\height}{\\includegraphics[width=0.5\\textwidth, height=20mm]{%s}}', Silhouette)
  ) 

tbl_species %>% 
 #dplyr::mutate(Silhouette = "Silhouette") %>% 
  knitr::kable(caption = "Description of tree shapes and associated species", longtable = TRUE, escape = FALSE, booktabs = TRUE, linesep = "") %>% 
  kableExtra::kable_paper(full_width = TRUE) %>% 
  # kableExtra::column_spec(2, image = kableExtra::spec_image(here::here(tbl_species$Silhouette), 100*3, 100*3)) 
  kableExtra::column_spec(1, italic = TRUE) %>% 
  kableExtra::collapse_rows(1, latex_hline = "full") %>% 
  kableExtra::footnote(number = c("Colors are based on (NIR+G+B mapped to R, G, B channels).", "Adapted from Farrar (1995) and Leboeuf and Vaillancourt (2013)"))
```

## LiDAR Data Processing

Even-aged stands are less complex to analyze from a vertical structure
point of view than irregular stands, so we focused our analysis on
even-aged stands with clearly dominant species representing at least 50%
of the stand cover. The steps required to prepare LiDAR data for processing 
are sumarised in Figure \@ref(fig:fig-lidar-process).
We excluded stands with an average LiDAR sampling
rates below 2 pt/m² or an area of less than 4 ha to ensure sufficient
number of LiDAR returns. From these stands, we kept only those with a
dominant species that had at least 100 observations (stands): aspen,
balsam fir, black spruce, paper birch and white spruce. From 22 365
stands of the original forest map, we reduced our dataset to
5 428 stands representing 35% of the study area (Figure \@ref(fig:fig-loc)). Stand area
distributions were similar for all selected species (median 9 ha,
minimum 4 ha, maximum 137 ha).


```{r include = FALSE}
fig_process_caption <- "Preparation of the LiDAR data"
fig_process_short_caption <- "Preparation of the LiDAR data"
```

```{r fig-lidar-process, fig.cap=cap(fig_process_caption), fig.scap=fig_process_short_caption, echo = FALSE}
include("lidar-process", "pictures")
```

We registered the LiDAR returns in a common vertical system to make them comparable. 
We subtracted the ground elevation from the absolute point elevation to compute
the vertical distribution of LiDAR return for every stand [@muss_etal11].
Vertical distribution is a histogram of LiDAR returns height sliced in 40
horizontal sections relative to their highest returned point. The slices were
defined relative to maximal height [@harding_etal01; @coops_etal07] to allow
comparison across stands of different heights. We then divided each slice count
by the total number of points of the stand so each stand vertical distribution
summed to one to allow comparisons between stands of inconsistent shapes, areas,
and LiDAR point density.

Satistical Analysis
----------------------

We used a novel method that builds on the functional data analysis field
[@ramsay_silverman05] to compare the complete vertical distribution of LiDAR
returns. Most studies of species classification have focused on the accuracy of
classifiers and the value of predictors for classification [@fassnacht_etal16], often using
dimension reduction to decrease and decorrelate the number of predictors such as linear
discriminant analysis or principal component analysis [@koenig_hofle16;
@raty_etal16; @axelsson_etal18]. However, dimension reduction decreases the
ability to understand the effect of a given variable and interpret the results
of the model.

To compare inter- and intraspecific variations in the distribution of LiDAR returns and the
confounding variables, we used a nonparametric graphical test of
significance [@myllymaki_mrkvicka19; @mrkvicka_etal19] (Figure \@ref(fig:fig-fglm-process)). 
We modeled the vertical
distributions of LiDAR returns as a function of dominant species, crown cover,
and age using the general linear model

\begin{equation}
d_i(h) = \beta_0(h)+\beta_{sp}(h)\cdot Species_i + \beta_{cc}(h) \cdot CC_i +
\beta_{age}(h) \cdot Age_i + \varepsilon_i(h)   (\#eq:full)
\end{equation}

```{r include = FALSE}
fig_fglm_caption <- "Analysis of the vertical distribution of LiDAR returns"
fig_fglm_short_caption <- "Analysis of the vertical distribution of LiDAR returns"
```

```{r fig-fglm-process, fig.cap=cap(fig_fglm_caption), fig.scap=fig_fglm_short_caption, echo = FALSE}
include("fglm", "pictures")
```



where $d_i$ contains the LiDAR density distribution at scaled height $h$
(represented by the vertical distribution histogram) for observation $i$, and
$\beta(h)$ is the parameter vector related to each variable, $CC$ is crown
cover, and $\varepsilon(h)$ is the error term with mean zero and finite variance $\sigma^2$. 
Species as well as ​age---given that the last class was open---were regarded as
categorical variables and thus encoded with dummy variables in $Species_i$ and
$Age_i$, while $CC_i$ was regarded as a continuous variable.

We studied the effect of each variable after accounting for the other
confounding variables (also called the nuisance factors by Freedman and Lane
-@freedman_lane83). We tested the three null hypotheses $\beta_{sp, m}(h)=0$ for all $m$ and $h$, 
$\beta_{cc}(h)=0$ for all $h$, and $\beta_{age, l}(h)=0$
for all $l$ and $h$ for the three variables, respectively. 
For the discrete factors, $m$ and $l$ are equal to the number of groups of the 
discrete factor and the coefficients were constrained to sum to zero.
The corresponding three null models were obtained by removing the
studied variable from the full model (Equation \@ref(eq:full)),

\begin{equation}
d_i(h) = \beta_0(h)+ \beta_{cc}(h) \cdot CC_i +
\beta_{age}(h) \cdot Age_i + \varepsilon_i(h)   (\#eq:species)
\end{equation}

\begin{equation}
d_i(h) = \beta_0(h) + \beta_{sp}(h) \cdot Species_i +
\beta_{age}(h) \cdot Age_i + \varepsilon_i(h)   (\#eq:cc)
\end{equation}

\begin{equation}
d_i(h) = \beta_0(h)+\beta_{sp}(h)\cdot Species_i + \beta_{cc}(h) \cdot CC_i + 
\varepsilon_i(h)    (\#eq:age)
\end{equation}

We used the coefficients of the variable of interest
(the left-out $\beta$ in Equations \@ref(eq:species)--\@ref(eq:age)) for the 
statistical test as suggested by @mrkvicka_etal19: 
for the continuous crown cover variable, the test statistic
was the vector $\beta_{cc}(h)$ for all $h$; for age, the test was based on the 
values of the effect $\beta_{age,l}(h)$ of all the age groups $l$ for all $h$. 
To inspect species differences,
another alternative was used: the test was based on all differences
$\beta_{sp, m}(h)-\beta_{sp, n}(h)$ for species $m$ and $n$ with $1≤m<n≤5$. 

The test relies on two procedures: 1) Freedman-Lane algorithm to permute the
residuals of the null model and create the reference distribution of the
coefficients under the null hypothesis, and 2) the *global extreme rank length
envelope test* to build a null global envelope for the above mentioned test 
statistics and correct for the multiple tests conducted along $h$
[@myllymaki_etal17]. The Freedman-Lane algorithm includes all steps from the 
Simulation under the null hypothesis to the estimation of the coefficients 
under the null hypothesis (Figure \@ref(fig:fig-fglm-process)).

The null hypothesis was rejected if the test vector, calculated from the vertical
distribution of LiDAR returns, leaved the envelope at any point. We used 2999
random permutations to estimate the $p$-value and to build the global envelopes
for the nonparametric graphical test of significance [@myllymaki_mrkvicka19]. To
account for the tests of all three variables, we 
used a Bonferroni adjusted significance level $\alpha = 0.05/3$ in addition
to the inherent correction applied within the *global extreme rank length
envelope test* to account for multiple $h$, and
consequently considered the 98% global envelopes. We checked the data for
heterogeneity of variance [@winkler_etal14], and the model residuals
indicated heterogeneity of variance for all variables.
Following @mrkvicka_etal20, we transformed the matrix of vertical LiDAR return 
density (Figure \@ref(fig:fig-fglm-process)) by scaling groups ($j$)
according to their variance dispersion. The initial $d_{i,j}$ function was
transformed into $S_{i,j}$ function,

\begin{equation}
S_{i,j}(h) = \frac{d_{i,j}(h) - \bar{d_j}(r)}{\sqrt{Var(d_j(h))}} \cdot
  \sqrt{Var(d(h))} + \bar{d_j}(h)  
(\#eq:variance)
\end{equation}

where the group sample variance $Var(d_j(h))$ is used to correct for unequal
variance among groups. The group sample mean $\bar{d_j}(h)$ and overall variance $Var(d(h))$
are used to preserve the original scale of the mean and variability of the functions.

Our experiments with simulated data showed that the application of the
transformation for all groups at once (by combining all group levels)
generally removed heterogeneity of the variance, but it required to have
sufficient observations in all categories, which was not the case of our
data. We instead relied on the successive application of the transformation
(Equation \@ref(eq:variance)) for each of the confounding variables. In this
case, we found that the order in which the transformation is applied is
important because it can reintroduce heterogeneity of variance. We
settled on the successive transformation by crown cover, age, and species
which provided the best results and reduced heterogeneity. We verified
the importance of the correlation by running Breusch-Pagan [@breusch_pagan79] test of
heteroscedasticity using the squared residuals $(d_i(h) - \hat{d_i}(h))²$ on
the left-hand side of the reduced equations \@ref(eq:species)--\@ref(eq:age).
While the test indicated significant heteroscedasticity in some areas of the
curves, the coefficient of determination was less than 4% for all variables and
all $h$, which confirmed that no further adjustment was required.

We performed the analysis using R 3.6.3 [@rcoreteam20], the GET package
[@myllymaki_mrkvicka19; @mrkvicka_etal19], and Lastools [@isenburg12] to correct
and extract the LiDAR data.

Results
=====================

The contrasts from the nonparametric graphical test of significance
confirm that we can reject the null hypothesis: the differences between
all species, after accounting for age and crown cover, were significantly
different ($p$ < 0.001) (Figure \@ref(fig:fig-sp)). We observed two groups of
species where differences were significant but small: balsam fir–paper
birch, and black spruce–white spruce. Balsam fir and paper birch differences
were small and localized at 65–70% and below 12% of stand height. White spruce
and black spruce also had small localized differences at 22–30% and
5–8% of stand height. However, some differences were more important between groups of
species (indicated by the bold lines in Figure \@ref(fig:fig-sp)): black and white spruces had the lowest distribution of LiDAR
returns when compared to other species. Black spruce had fewer returns
than balsam fir between 38–62% of stand height (40–57% for paper birch), while
it had more below 28% of stand height (30% for paper birch). Aspen’s vertical
distribution of LiDAR returns had a significantly distinctive shape when
compared to every other species: it did not display a prominent peak,
which made the distribution more uniform than other species 
(Figures \@ref(fig:fig-cc2) and \@ref(fig:fig-age2)). Except for
the area between 57–60% of height for all species, and 8–18% for balsam
fir and paper birch, all differences with aspen were significant ($p$<0.001). 
Overall, areas of larger differences for species
were located around 5, 25, 50, and 70% of stand height.

```{r include = FALSE}
fig_sp_caption <- "Nonparametric graphical
tests of significance for species using contrasts: 
the observed difference between the coefficients of two species (black curve), 
where species in rows are subtracted from the species in columns (e.g. first 
column, second row is the aspen − balsam fir contrast), and the 98% global 
envelope (grey bands below the diagonal) that shows the area of acceptance 
of the null hypothesis (no effect, $p$<0.001) obtained from the permutations 
of the residuals of the null model (Equation \\@ref(eq:species)). The observed 
curve is bolder when outside the envelope. Panels above the diagonal are the 
reflection of the observed functions 
and the global envelope from the lower part."

fig_sp_short_caption <- "Nonparametric graphical
tests of significance for species"
```


```{r fig-sp, fig.cap=cap(fig_sp_caption), fig.scap=cap(fig_sp_short_caption), echo = FALSE}
include("fig-sp-combined")
```


```{r include = FALSE}
fig_cc2_caption <- 
"Vertical distribution of LiDAR returns 
as a function of crown cover (columns) and species (rows). Black lines
represent the median distribution; shaded areas represent 95% and 50%
local variation envelopes."
fig_cc2_short_caption <- "Vertical distribution of LiDAR returns 
as a function of crown cover and species."
```


```{r fig-cc2, fig.cap=cap(fig_cc2_caption), fig.scap=cap(fig_cc2_short_caption), echo = FALSE}
include("fig-cc")
```

```{r include = FALSE}
fig_age2_caption <- 
"Vertical distribution of LiDAR returns as a function of age
(columns) and species (rows). Black lines represent the median
distribution; shaded areas represent 95% and 50% local variation envelopes."
fig_age2_short_caption <- "Vertical distribution of LiDAR returns 
as a function of age groups and species."
```


```{r fig-age2, fig.cap=cap(fig_age2_caption), fig.scap=cap(fig_age2_short_caption), echo = FALSE}
include("fig-age2")
```

An increase in crown cover was associated with a decrease in the density of
LiDAR returns below 33% of stand height, while the density of LiDAR returns
above 38% increased (Figure \@ref(fig:fig-cc)). The largest augmentation was
concentrated around the middle height (50%), while the inferior area (around 3%
of height) had the largest reduction effect. Note that through the text we use
*inferior* to identify the parts of the forest stand that are closer to the
ground, and *superior* for the inverse. Figure \@ref(fig:fig-cc2)
displays the effect of crown cover on each species vertical
distribution of LiDAR returns, including the effect of age. The increase in crown cover concentrated the
returns around the middle height, except for aspen which peak was located
superior (around 80% of stand height) and white spruce which peak was inferior (around
20%). Although black spruce peak was centered at 50% stand height for high values of crown cover, the observed
variability was skewed toward the inferior stand height. Some species were more 
represented in younger or older age classes, which inflated the variation envelopes. 
The model from Figure \@ref(fig:fig-cc) accounted for this effect.

```{r include = FALSE}
fig_cc_caption <- 
"Nonparametric graphical tests of significance for crown cover:
the observed coefficient (black curve), 
and the 98% global envelope (grey band) that shows the area of acceptance of 
the null hypothesis (no effect, $p$<0.001) obtained from the permutations of the 
residuals of the null model (Equation \\@ref(eq:cc)). The observed curve is 
bolder when outside the envelope."
fig_cc_short_caption <- "Nonparametric graphical tests of significance for crown cover"
```


```{r fig-cc, fig.cap=cap(fig_cc_caption), fig.scap=cap(fig_cc_short_caption), echo = FALSE}
include("fig-glm-cc")
```

The effect of increasing age gradually shifted the distribution higher
in the stand up to 70 years of age, when it seemed to reach a plateau
(Figure \@ref(fig:fig-age)). The effect of age was significant at most height 
for stands between 10 and 70 years of age, while significant effect for stands
of 90 and 120 years of age were of smaller magnitude and below 69% and
44% respectively ($p$<0.001). The gradual shift of the distribution toward the top
of the stand as age increased is reflected by the younger stands (10,
30 yr) with an abundance of lower returns below 28% and 41%
respectively, and fewer returns above 33% and 49% of height,
respectively. The effect is reversed in mature stands of 50 and 70
years, where age inflated the distribution between 38–97% of stand height
(44–100% for 70 yr), and deflated it below 31% of stand height (38% for
70 yr). Like mature stands, older stands of 90 and 120 years of age also
had an abundance of returns in the superior part of the stand, although it was
lower than mature stands (90 yr: 38–68%; 120 yr: 33–44%) and of smaller
magnitude. Older stands vertical distribution were reduced
below 28 and 23% of stand height for 90 and 120 years of age,
respectively. Overall, the rate of change in the vertical distribution of LiDAR
returns gradually decreased as the age increased. For example, changes
in the distribution between 10 and 30 years were larger than the changes
between 70 and 90 years. Overall, areas of higher variability for age
groups were located around 5, 20, and 50% of stand height. Figure
\@ref(fig:fig-age2) displays the effect of age on each species vertical
distribution of LiDAR returns. The young white and black spruces stand displayed
a strong asymmetry toward the inferior part of the stand that disappeared in
older stands.

```{r include = FALSE}
fig_age_caption <- 
"
The nonparametric graphical tests of significance for age:
the observed coefficients of the six age groups (black curves), 
and the 98% global envelope (grey bands below the diagonal) that shows the 
area of acceptance of the null hypothesis (no effect, $p$<0.001) obtained from 
the permutations of the residuals of the null model (Eq. \\@ref(eq:age)). 
The observed curve is bolder when outside the envelope.
"
fig_age_short_caption <- "Nonparametric graphical tests of significance for age"
```


```{r fig-age, fig.cap=cap(fig_age_caption), fig.scap=cap(fig_age_short_caption), echo = FALSE}
include("fig-age")
```

The coefficient of determination of the models varied across stand height (Figure 
\@ref(fig:fig-rsq)). The most correlated areas for every model were around
5--15%, and 46--54% of stand height, while all models displayed a sharp decline
between 28--40%. The highest R² was for the full model
at 0.47 (at 10--13% of height) and 0.42 (at 49--51%). The model explicitly
excluding the species variable (Eq. \@ref(eq:species)) displayed a difference of
more than 0.10 with the full model R² between 72--92% stand height. Excluding
the crown cover variable from the model (Eq. \@ref(eq:cc)) created a
difference of more than 0.10 with the full model R² between 0--21% and 46--67%
of stand height. The model excluding the age variable (Eq. \@ref(eq:age))
displayed a difference of more than 0.10 with the full model R² at 18--38% and
62--64% of stand height.

```{r include = FALSE}
fig_rsq_caption <- 
"Comparison of $R²(h)$ of the full model (Eq. \\@ref(eq:full)) containing all 
variables, and the three reduced models (Eq. \\@ref(eq:species)--\\@ref(eq:age))
where one variable has been left out (either Species, Crown Cover, or Age)."
fig_rsq_short_caption <- "Comparison of $R²(h)$."
```


```{r fig-rsq, fig.cap=cap(fig_rsq_caption), fig.scap=cap(fig_rsq_short_caption), echo = FALSE, out.width="60%"}
include("fig-r-squared")
```


Discussion
========================

Our objective was to study the influence of species, crown
cover and age on the vertical distribution of LiDAR returns. We found
that even-aged stands exhibit species-specific patterns that evolve
predictably with crown cover and age. We observed two groups of
species: balsam fir and paper birch which had a more symmetrical
vertical distribution of LiDAR returns centered between 40 and 60% of
stand height, and white spruce and black spruce distributions
of LiDAR returns that were generally skewed toward the inferior part (closer to ground) of
the stand (below 30%). Aspen displayed a more even distribution of LiDAR
returns with a higher proportion of returns in the superior part of the stand 
than other species.

While individual trees are all plastic and opportunistic, adapting to
specific light and environmental conditions, we found that
stands of a species exhibit similar vertical characteristics that distinguish
them from other species. This observation is consistent with previous field 
observations conducted on a smaller area with different measurement
methods [@purves_etal07]. However, we expected clearer
patterns along a shade-tolerance gradient or conifer versus deciduous;
we found that patterns of paper birch were more similar to balsam fir
than aspen, another shade-intolerant deciduous, while balsam fir is a
shade-tolerant conifer. Since we used the dominant species to classify
stands, this could be the result of frequent association between balsam
fir and paper birch in the same stand.

Increased crown cover was associated with a concentration of the vertical
distribution of LiDAR returns which moved points below 33% to above 38% of stand
height. Complementarily, stands with a lower crown cover presented a vertical
distribution of LiDAR returns that was more dispersed and skewed toward the
ground, with fewer returns in the superior part of the stand. This effect was
also apparent when comparing the variance explained by the models in Figure
\@ref(fig:fig-rsq) where crown cover appeared to contribute to explain at
least 25% from the variance explained by the full model below 21% and between
44--69% of stand height.

Age increase was associated with a displacement of the vertical
distribution of LiDAR returns to the top of the stand for up to 50–70
years and then plateaued or declined in the 90–120 years groups. The
rate of change between age groups decreased as the age increased: younger
stands vertical distribution of LiDAR returns appeared to undergo a
rapid transformation in the 10 yr group, which gradually decelerated to
stabilize in the 70 years group. The 90 and 120 years groups displayed
the smallest magnitude of change. While it is well established that 
absolute stand height varies predictably with age, the changes we observed here 
are relative to the maximal height of the stand. Age effect was akin to the 
crown cover effect: while they increased, they were both associated to an 
increased proportion of points in the superior part of the stand. The crown 
cover variable however seemed to explain more of the distribution variations 
in the lower stand (below 21%) and the middle stand (46--67%), while age 
contribution to R² happened between 18--38%. Unlike @aber79 who observed 
a stable distribution of foliage at the end point of the forest succession, the
vertical distribution of LiDAR returns of the 120 year class rather 
displayed a marginal concentration below the middle height (33--38%).

The most important differences between vertical LiDAR distributions occurred
below 80% of height. The superior sections of the stand often displayed very
small differences in distributions while the inferior portion displayed large
variations. The distribution of LiDAR returns in the superior and inferior
portions of the stand can be highly dependent on the LiDAR survey parameters
[@roussel_etal17; @roussel_etal18], which might make them less likely to be
stable across different surveys. Nonetheless, the full model (Eq.
\@ref(eq:full)) still explained 20% of the variability up to 90% of stand
height. The difference in variability explained by the species model compared to
the full model was more important above 72% and peaked at around 80% (Figure
\@ref(fig:fig-rsq)). One possible explanation is that the area 74--90% is
associated to important differences between aspen and all other species, which
were probably not explained by crown cover or age. 

The area 31--46% of stand height exhibited a sharp decline in R², where age seemed
to explain most of the variance of the full model. While the reasons for this
sharp drop are unknown, the area is associated with an increase in LiDAR returns
for stands of the 120 yr group and seems to be a transition area for the
spruce group and the balsam fir--paper birch group between an inferior--skewed
distribution and a centered distribution. The meeting of these two distributions
might create noise which might be amplified by the registration of the
curves---scaling the curves relative to the highest return received.

Interestingly, the graphical test of significance rejected the hypothesis that
the distributions of LiDAR returns were similar, and also identified the areas
responsible for the rejection. This allowed to form groups of species with
similar distributions. We think that this
method could complement and sometimes replace other methods of analysis of the
vertical distribution of LiDAR returns, such as principal component analysis or
linear discriminant analysis when interpretability is desired.

## Limitations

The median stand area was 9 ha, a large area compared to other area-based
approaches, which allowed the aggregation of LiDAR returns to identify specific
patterns. Stands are by design the most homogeneous unit of the forest landscape
and vertical LiDAR distributions are more reliable after a sufficient number of
aggregated returns are grouped. The exact optimal area to observe these patterns
will require additional research.

The vertical distribution of LiDAR returns for each stand was scaled using the
highest LiDAR return. This could make the registration sensitive to extreme
measures and might explain, in part, why the superior part of the canopy's R²
was lower. In young stands, where a single mature tree might remain, the
distortion of the vertical distribution of LiDAR returns could be high and
reduced as the trees approach their maximal height for the site. Using a high 
quantile rather than the highest return could reduce this effect.
Nonetheless, the variance explained by the model using highest--point 
registration still proved useful. 
Returns from the inferior parts of the stands are also subject to occlusion which reduces the proportion of points that can be recorded; corrections can be applied to account for occlusion [@roussel_etal17; @roussel_etal18; @wilkes_etal16].

The non-parametric graphical test of significance that we used is slightly
liberal because the Freedman-Lane permutation is approximate
[@mrkvicka_etal19], however, the permutation scheme is regarded as
one of the best methods from the literature
under the presence of confounding variables [@winkler_etal14; @anderson_robinson01]. It also has the
advantage of the graphical interpretation, especially the identification of the
 area of rejection, which allowed us to interpret at which relative heights 
 and between which species the differences occurred.

This study focused on stands with a dominant species composing at least 50% of the stand. 
Using a low threshold for the dominance increases the number of observations elligble to the analysis and our ability to detect effects, but adds noise (because the rest of the stand is composed of other species). 
In our case, 50% dominance provided a good balance between data and noise, and allowed for a sufficiently large number of stands and species. 
We also focused our study on stands with sufficient LiDAR sampling and even-aged stands to reduce the noise that could be created by other confounding factors, such as multiple statums.
The model could in theory support more descriptive variables, such as  multi-age or multi-stratum descriptors, but it would require a sufficiently large number of stands. 
Practically, the number of stands is limited and adding interactions makes interpretation more difficult. 
One way to reduce the noise associated to more complex stands, might be to reduce the area on which the distribution is computed.
As we improve the understanding of the association between variables and vertical distribution of LiDAR returns, and isolate effects, it might be possible to add more variables to a model and include more complex stands.


## Future outlook

We found differences in the distributions of LiDAR returns of five tree species.
The graphical test of significance allowed an interpretation of the vertical
distribution of LiDAR returns, which could
be used to improve our understanding of stand structure evolution and species
classification with LiDAR. 
In a review of remote sensing tree species
classification, Fassnacht et al. -@fassnacht_etal16 noted that most studies
pursued the optimization of classification accuracy, and provided little
analysis of the causal understanding of species discrimination. 
The nonparametric graphical test of significance method can help study the evolution of forest structure by allowing the association of variables to the distribution of reflective material. 
In this paper, we applied the method to a selection of simple stands (cleat species dominance, 
and even-age) to visually understand the effect of each of these factors.
Further work is required to apply the method to multi-species, or irregular stands.

Species classification could be performed by training a model to associate vertical LiDAR distributions to species, essentially inverting the process used in this paper. 
While fGLM is not particularly suited to predictions, non parametric methods, such as Deep Neural Network could be good candidates for species classification because they can handle the functional representation of the data and their non-linear relations. 

Additional evidence is needed to establish if the relation between
vertical density of LiDAR returns, and species, crown cover, and age
are circumstantial to our study area, or if they hold in other areas,
with different species, and LiDAR survey parameters. Other variables, such as
LiDAR scan angle and abiotic factors, could be included to improve the model.

Our results indicate that LiDAR vertical distribution can be analyzed using 
a graphical test of significance. These results can be used extensively to 
study forest structure on a new scale. 

Conclusion
========================

Using light detection and ranging (LiDAR) vertical distributions can
provide an understanding of the interplay between species, crown cover,
and age. The use of the functional generalised linear models combined to the 
graphical test of significance allows
interpreting the differences in distributions explained by multiple
confounding variables. By using an airborne LiDAR survey, it is possible
to find ecosystems at multiple evolution stages to observe LiDAR
patterns variations and eventually link them to structural and 
functional dynamics. Our results show that species feature distinctive
vertical distributions of LiDAR returns that concentrate with crown
cover and rise with age. Balsam fir and paper birch had a similar
vertical distribution of LiDAR returns, like white spruce and black
spruce. Aspen was the most different species with a more uniform
distribution of LiDAR returns and a peak in the superior part of the stand. 
Balsam fir–paper birch displayed a peak centered
around 50% of stand height, while the white–black spruces had their
distributions skewed below 30% of stand height. Increase in crown 
cover concentrated the distributions around 50% by deflating the 
distribution below 33%, while age affected was more diffuse across the whole 
stand height. These results could improve our understanding of the 
evolution of the forest structure over changing conditions and could be used 
for stand-level species classification with LiDAR.

Acknowledgments {-}
================

We thank Benoît St-Onge, Nicole K. S. Barker, Sébastien Renard,
Christian Roy and Josh Nowak for comments on early versions of this
manuscript; Tomáš Mrkvička for helpful discussions on the transformations of 
heteroscedastic data; Anick Patry, Antoine Leboeuf, Marc-Olivier Lemonde, 
and Jean-François Bourdon from
Ministère des Forêts, de la Faune et des Parcs for providing data and
support.

Declarations {-}
================

Funding {-}
------------

This work was supported by the Ministère des Forêts de la Faune et des
Parcs du Québec through the Fonds de Recherche Québécois sur la Nature
et les Technologies and the Academy of Finland (project numbers 295100 and 327211).

Conflicts of interest/Competing interests {-}
----------------------------------------------

We declare no conflict of interest.

Availability of data and material {-}
-------------------------------------

The original data was shared and is available upon request to the
Gouvernement du Québec. The processed data is available in our
repository https://github.com/etiennebr/vertical-lidar-paper

Code availability {-}
----------------------

The code to perform the analysis is available in a git repository at
https://github.com/etiennebr/vertical-lidar-paper

### Author contribution statement {-}

ER is the primary author of the manuscript. ER, NCC and JB contributed
to the design of the study; the analysis was conducted by ER and MM, the
redaction was conducted by ER and revised by other authors; all authors
read and approved this version to be published.

`r if (!knitr::is_latex_output()) '
# References {-}
<div id="refs" class="references"></div>
'`

`r if (knitr::is_latex_output()) '
\\section*{References}
'`
