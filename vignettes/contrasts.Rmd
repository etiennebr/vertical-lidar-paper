---
title: "contrasts"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{contrasts}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
devtools::load_all(here::here("../vertical-lidar-paper"))
library(GET)
library(patchwork)
library(tibble)
library(ggplot2)
library(dplyr)
library(tidyr)
library(purrr)

ggplot2::theme_set(theme_pub())
alpha <- 0.05 / 3  # (Bonferroni correction)
nperm <- 100  # number of permutations
m <- 40-1  # number of discrete points per functions

# test variance equality
functional_anova <- function(g, nsim = nperm, contrasts = TRUE, curve_set = cset_trans, ...) {
  GET::graph.fanova(
    nsim = nsim,
    curve_set = curve_set,
    groups = g,
    variances = "unequal",
    test.equality = "var",
    contrasts = contrasts,
    alpha = alpha
    #lm.args = list(weights = weights$weight)
  )
}

# Transformation to equalize variances in groups
corrUnequalVar <- function(curve_set, groups, n.aver = 1L, mirror = FALSE) {
  if (!is.factor(groups)) {
    groups <- factor(groups)
  }
  x <- GET:::data_and_sim_curves(curve_set)
  # Group means, (bar{T}_j(r))
  m <- GET:::groupmeans(x, groups)
  # Sample variance over all functions, Var(T(r))
  varT <- GET:::vvar(x)
  # Variances in the groups, Var(T_j(r))
  v <- GET:::groupvar(x, groups)
  # Moving average
  if(n.aver>1){
    v <- t(apply(v, 1, GET:::maverage, n.aver=n.aver, mirror=mirror))
    varT <- GET:::maverage(varT, n.aver=n.aver, mirror=mirror)
  }
  # Take S_ij(r) = (T_ij(r) - \bar{T}_j(r)) / \sqrt( Var(T_j(r)) ) * \sqrt{Var(T(r))} + \bar{T}_j(r)
  for(i in 1:nrow(x)) {
    x[i,] <- (x[i,] - m[which(rownames(m) == groups[i]),]) / sqrt(v[which(rownames(v) == groups[i]),]) * sqrt(varT) + m[which(rownames(m) == groups[i]),]
  }
  curve_set$funcs <- t(x)
  curve_set
}
```

## Homogeneity

Check homogeneity of variance (Winkler et al. 2014)
```{r}
# wave can be create once with `source("data-raw/lidar_wave.R")`

# Transform to the GET format
mobs <- wave %>% 
  dplyr::select(starts_with("ss_")) %>% 
  as.matrix()

independent_factors <- wave %>% 
  select(
    dominant_species, age_class, crown_closure
  ) %>% 
  mutate(
    dominant_species = factor(dominant_species),
    age_class = factor(age_class)
  ) %>% 
  as.data.frame()

cset <- create_curve_set(list(r = seq_len(ncol(mobs)), obs = t(mobs)))

res_fanova_sp <- functional_anova(independent_factors$dominant_species, contrasts = FALSE, curve_set = cset)
my_plot_contrasts(res_fanova_sp, m)

# Successively equalize variance for each group
cset_trans <- corrUnequalVar(cset, groups=with(independent_factors, crown_closure))
res_fanova_sp <- functional_anova(independent_factors$dominant_species, contrasts = FALSE, curve_set = cset_trans)
pa <- plot(res_fanova_sp) + coord_flip()

cset_trans <- corrUnequalVar(cset_trans, groups=with(independent_factors, age_class))
res_fanova_sp <- functional_anova(independent_factors$dominant_species, contrasts = FALSE, curve_set = cset_trans)
pb <- plot(res_fanova_sp) + coord_flip()

cset_trans <- corrUnequalVar(cset_trans, groups=with(independent_factors, dominant_species))
res_fanova_sp <- functional_anova(independent_factors$dominant_species, contrasts = FALSE, curve_set = cset_trans)
pc <- plot(res_fanova_sp) + coord_flip()

pa + pb + pc
```
The order of transformation is important here. From experimentation, we found
that cc>age>sp gives the best results. By using simulated data, we observed that
applying the transformations at once (with e.g. `interaction()`) gives the best
correction because it generally completely removes the heteroscedasticity, while
successive transformations can reintroduce heteroscedasticity in other areas of
the curve. Given our unbalanced data, with missing combinations of predictors,
we could not apply the transformation at once. However, the remaining areas of
heteroscedasticity did not seem to affect the final results of simulated data,
especially with datasets with the same number of observations. The test of
heteroscedasticity ($Z_{ij}(r) = T_{ij}(r) - \bar{T}_j(r)$) appeared to be more
conservative for larger datasets (i.e. 5000 observations), than with smaller
datasets (e.g. 200 observations). For example, the test would not indicate
heterogenuous variance on a dataset downsampled from a large dataset in which 
the test found heteroscedasticity.

```{r}
res_fanova_sp <- functional_anova(independent_factors$dominant_species, contrasts = FALSE, curve_set = cset) %>% 
  plot() + coord_flip()
res_fanova_sp_trans <- functional_anova(independent_factors$dominant_species, contrasts = FALSE, curve_set = cset_trans) %>% 
  plot() + coord_flip()
res_fanova_cc <- functional_anova(factor(independent_factors$crown_closure), contrasts = FALSE, curve_set = cset) %>% 
  plot() + coord_flip()
res_fanova_cc_trans <- functional_anova(factor(independent_factors$crown_closure), contrasts = FALSE, curve_set = cset_trans) %>% 
  plot() + coord_flip()
res_fanova_age <- functional_anova(independent_factors$age_class, contrasts = FALSE, curve_set = cset) %>% 
  plot() + coord_flip()
res_fanova_age_trans <- functional_anova(independent_factors$age_class, contrasts = FALSE, curve_set = cset_trans) %>% 
  plot() + coord_flip()

# Compare before and after transformation
res_fanova_sp + res_fanova_cc + res_fanova_age
res_fanova_sp_trans + res_fanova_cc_trans + res_fanova_age_trans
```


## GLM

The envelopes are created from `r nperm` permutations.
```{r}
functional_lm <- function(null_model, nsim = nperm, contrasts = TRUE, ...) {
  graph.flm(
    nsim = nsim,
    formula.full = Y ~ dominant_species + age_class + crown_closure,
    formula.reduced = null_model,
    curve_sets = cset_trans,
    factors = independent_factors,
    contrasts = contrasts,
    GET.args = list(alpha = alpha),
    ...
  )
}
res_flm_sp <- functional_lm(Y ~ age_class + crown_closure)
res_flm_cc <- functional_lm(Y ~ dominant_species + age_class, contrasts = FALSE)
res_flm_age <- functional_lm(Y ~ dominant_species + crown_closure, contrasts = FALSE)
```

### Contrasts
```{r}
p <- my_plot_contrasts(res_flm_sp, 39, full = TRUE)

u <- my_plot_continuous(res_flm_cc, 39, main = "my main")  + 
  #scale_y_continuous("Scaled density difference (×10⁻⁴)", labels = function(x) paste0(x * 1000)) +
  NULL
v <- my_plot_continuous(res_flm_age, 39) + 
  #scale_y_continuous("Scaled density difference (×10⁻³)", labels = function(x) paste0(x * 100)) +
  NULL

(p + ggtitle("Species")) / 
(u + ggtitle("Crown closure")) / 
(v + ggtitle("Age")) +
  plot_layout(heights = c(2, 2, 1))

# Save figures independently
# device <- "png" # pdf
device <- "pdf"
ggsave("figure/fig3-sp-contrasts.pdf", p, device = device, dpi = "retina", width = 234, height = 234, units = "mm")
ggsave("figure/fig5-cc-contrasts.pdf", u, device = device, dpi = "retina", width = 234/2, height = 234/2, units = "mm")
ggsave("figure/fig7-age-contrasts.pdf", v, device = device, dpi = "retina", width = 234, height = 234/2, units = "mm")
```

### p-values
```{r}
p_value(res_flm_sp)
p_value(res_flm_age)
p_value(res_flm_cc)
```

### Summary figure
```{r}
# Species variations ==========================================================
direct_labels <- tribble(
  ~label, ~r, ~curves,
  "Aspen", 0.75, 0.12,
  "Balsam fir", 0.56, 0.09,
  "Paper birch", 0.4, 0.11,
  "White spruce", 0.25, 0.14,
  "Black spruce", 0.05, 0.19
) %>% 
  mutate(a = tolower(label))

sp_v <- 
  res_flm_sp %>% 
  my_plot_data_combined_global_envelope(scale_r = 39) %>% 
  .$ribbon %>% 
  filter(
    type == "Data function",
  ) %>% 
  fill_contrast_matrix() %>% 
  group_by(a, r) %>% 
  summarise(
    curves = sum(abs(curves))
  ) %>% 
  ggplot(aes(x = r, y = curves)) + 
  geom_line(aes(group = a, color = a), show.legend = FALSE) +
  geom_line(data = . %>% group_by(r) %>% summarise(curves = sum(abs(curves)))) +
  geom_text(data = direct_labels, aes(label = label, color = a), show.legend = FALSE, hjust = "left") +
  xlab("Scaled Stand Height") +
  ylab("Sum of absolute scaled density difference") +
  scale_color_brewer("Species", type = "qual", palette = "Dark2") + 
  coord_flip()

# Crown closure variations ====================================================
cc_v <- res_flm_cc %>% 
  my_plot_data_combined_global_envelope(scale_r = 39, main = "main") %>% 
  .$ribbon %>% 
  filter(
    type == "Data function",
  ) %>% 
  fill_contrast_matrix() %>% 
  group_by(a, r) %>% 
  summarise(
    curves = sum(curves)
  ) %>% 
  ggplot(aes(x = r, y = curves)) + 
  geom_line(aes(group = interaction(a), color = a), show.legend = FALSE) +
  geom_line(data = . %>% group_by(r) %>% summarise(curves = sum(abs(curves)))) +
  xlab("Scaled Stand Height") +
  ylab("Sum of scaled density difference") +
  #directlabels::geom_dl(aes(label = a, color = a), method = "last.bumpup") +
  scale_color_manual(values = pal_cc[4]) +
  coord_flip()

# Age variations ===============================================================
age_v <- res_flm_age %>% 
  my_plot_data_combined_global_envelope(scale_r = 39) %>% 
  .$ribbon %>% 
  filter(
    type == "Data function",
  ) %>% 
  mutate(a = b) %>%  # move age class to column a
  group_by(a, r) %>% 
  summarise(
    curves = sum(curves)
  ) %>% 
  ggplot(aes(x = r, y = curves)) + 
  geom_line(aes(group = interaction(a), color = a), show.legend = FALSE) +
  geom_line(data = . %>% group_by(r) %>% summarise(curves = sum(abs(curves)))) +
  xlab("Scaled Stand Height") +
  ylab("Sum of scaled density difference") +
  scale_color_manual(values = pal_age) +
  directlabels::geom_dl(aes(label = a, color = a), method = "last.bumpup") +
  coord_flip()

sp_v + cc_v + age_v

res_flm_age %>% 
  my_plot_data_combined_global_envelope(scale_r = 39) %>% 
  .$ribbon %>% 
  filter(
    type == "Data function",
  ) %>% 
  fill_contrast_matrix() %>% 
  mutate(
    a = sort_num_factor(a),
    b = sort_num_factor(b)
  ) %>% 
  ggplot(aes(x = r, y = curves, group = interaction(type, a, b))) + 
  geom_ribbon(aes(x = r, ymin = lower, ymax = upper), fill = "black", alpha = 0.01) +
  geom_segment(aes(xend = x_end, yend = y_end, color = ifelse(!inside & !inside_lead, "outside", NA)), show.legend = FALSE) +
  xlab("Scaled Stand Height") +
  ylab("Scaled density difference") +
  facet_grid(~a)+
  coord_flip()
```
