---
title: "contrasts"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{contrasts}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
devtools::load_all(here::here("../vertical-lidar-paper"))
library(GET)
library(patchwork)
library(tibble)
library(ggplot2)
library(dplyr)
library(tidyr)
library(purrr)

ggplot2::theme_set(theme_pub())
alpha <- 0.05 / 3  # (Bonferroni correction)
nperm <- 3000-1  # number of permutations
m <- 40-1  # number of discrete points per functions
device <- "pdf"
plot_use_trans <- TRUE  # use transformed data for plots

# test variance equality
functional_anova <- function(g, nsim = nperm, contrasts = TRUE, curve_set = cset_trans, ...) {
  GET::graph.fanova(
    nsim = nsim,
    curve_set = curve_set,
    groups = g,
    variances = "unequal",
    test.equality = "var",
    contrasts = contrasts,
    alpha = alpha
    #lm.args = list(weights = weights$weight)
  )
}

# Transformation to equalize variances in groups
corrUnequalVar <- function(curve_set, groups, n.aver = 1L, mirror = FALSE) {
  if (!is.factor(groups)) {
    groups <- factor(groups)
  }
  x <- GET:::data_and_sim_curves(curve_set)
  # Group means, (bar{T}_j(r))
  m <- GET:::groupmeans(x, groups)
  # Sample variance over all functions, Var(T(r))
  varT <- GET:::vvar(x)
  # Variances in the groups, Var(T_j(r))
  v <- GET:::groupvar(x, groups)
  # Moving average
  if(n.aver>1){
    v <- t(apply(v, 1, GET:::maverage, n.aver=n.aver, mirror=mirror))
    varT <- GET:::maverage(varT, n.aver=n.aver, mirror=mirror)
  }
  # Take S_ij(r) = (T_ij(r) - \bar{T}_j(r)) / \sqrt( Var(T_j(r)) ) * \sqrt{Var(T(r))} + \bar{T}_j(r)
  for(i in 1:nrow(x)) {
    x[i,] <- (x[i,] - m[which(rownames(m) == groups[i]),]) / sqrt(v[which(rownames(v) == groups[i]),]) * sqrt(varT) + m[which(rownames(m) == groups[i]),]
  }
  curve_set$funcs <- t(x)
  curve_set
}
```

## Homogeneity

Check homogeneity of variance (Winkler et al. 2014)
```{r}
# wave can be create once with `source("data-raw/lidar_wave.R")`

# Transform to the GET format
mobs <- wave %>% 
  dplyr::select(starts_with("ss_")) %>% 
  as.matrix()

independent_factors <- wave %>% 
  select(
    dominant_species, age_class, crown_closure
  ) %>% 
  mutate(
    dominant_species = factor(dominant_species),
    age_class = factor(age_class)
  ) %>% 
  as.data.frame()

cset <- create_curve_set(list(r = seq_len(ncol(mobs)), obs = t(mobs)))

res_fanova_sp <- functional_anova(independent_factors$dominant_species, contrasts = FALSE, curve_set = cset)
my_plot_contrasts(res_fanova_sp, m)

# Successively equalize variance for each group
cset_trans <- corrUnequalVar(cset, groups=with(independent_factors, crown_closure))
res_fanova_sp <- functional_anova(independent_factors$dominant_species, contrasts = FALSE, curve_set = cset_trans)
pa <- plot(res_fanova_sp) + coord_flip()

cset_trans <- corrUnequalVar(cset_trans, groups=with(independent_factors, age_class))
res_fanova_sp <- functional_anova(independent_factors$dominant_species, contrasts = FALSE, curve_set = cset_trans)
pb <- plot(res_fanova_sp) + coord_flip()

cset_trans <- corrUnequalVar(cset_trans, groups=with(independent_factors, dominant_species))
res_fanova_sp <- functional_anova(independent_factors$dominant_species, contrasts = FALSE, curve_set = cset_trans)
pc <- plot(res_fanova_sp) + coord_flip()

pa + pb + pc
```
The order of transformation is important here. From experimentation, we found
that cc>age>sp gives the best results. By using simulated data, we observed that
applying the transformations at once (with e.g. `interaction()`) gives the best
correction because it generally completely removes the heteroscedasticity, while
successive transformations can reintroduce heteroscedasticity in other areas of
the curve. Given our unbalanced data, with missing combinations of predictors,
we could not apply the transformation at once. However, the remaining areas of
heteroscedasticity did not seem to affect the final results of simulated data,
especially with datasets with the same number of observations. The test of
heteroscedasticity ($Z_{ij}(r) = T_{ij}(r) - \bar{T}_j(r)$) appeared to be more
conservative for larger datasets (i.e. 5000 observations), than with smaller
datasets (e.g. 200 observations). For example, the test would not indicate
heterogenuous variance on a dataset downsampled from a large dataset in which 
the test found heteroscedasticity.

```{r}
res_fanova_sp <- functional_anova(independent_factors$dominant_species, contrasts = FALSE, curve_set = cset) %>% 
  plot() + coord_flip()
res_fanova_sp_trans <- functional_anova(independent_factors$dominant_species, contrasts = FALSE, curve_set = cset_trans) %>% 
  plot() + coord_flip()
res_fanova_cc <- functional_anova(factor(independent_factors$crown_closure), contrasts = FALSE, curve_set = cset) %>% 
  plot() + coord_flip()
res_fanova_cc_trans <- functional_anova(factor(independent_factors$crown_closure), contrasts = FALSE, curve_set = cset_trans) %>% 
  plot() + coord_flip()
res_fanova_age <- functional_anova(independent_factors$age_class, contrasts = FALSE, curve_set = cset) %>% 
  plot() + coord_flip()
res_fanova_age_trans <- functional_anova(independent_factors$age_class, contrasts = FALSE, curve_set = cset_trans) %>% 
  plot() + coord_flip()

# Compare before and after transformation
res_fanova_sp + res_fanova_cc + res_fanova_age
res_fanova_sp_trans + res_fanova_cc_trans + res_fanova_age_trans
```


## GLM

The envelopes are created from `r nperm` permutations.
```{r}
functional_lm <- function(null_model, nsim = nperm, contrasts = TRUE, ...) {
  graph.flm(
    nsim = nsim,
    formula.full = Y ~ dominant_species + age_class + crown_closure,
    formula.reduced = null_model,
    curve_sets = cset_trans,
    factors = independent_factors,
    contrasts = contrasts,
    GET.args = list(alpha = alpha),
    ...
  )
}
res_flm_sp <- functional_lm(Y ~ age_class + crown_closure)
res_flm_cc <- functional_lm(Y ~ dominant_species + age_class, contrasts = FALSE)
res_flm_age <- functional_lm(Y ~ dominant_species + crown_closure, contrasts = FALSE)
```


### p-values
```{r}
p_value(res_flm_sp)
p_value(res_flm_age)
p_value(res_flm_cc)
```

# Figures

Create a transformed set of data with both transformed and untransformed data.
```{r}
trans_ss <- cset_trans[["funcs"]] %>% 
  t() %>%
  as_tibble() %>%
  set_names(~paste0("trans_", .x))

wave_long <- wave %>%
  bind_cols(trans_ss) %>%
  pivot_longer(
    cols = matches("ss_"),
    names_pattern = "(trans_)?ss_(\\d+)",
    names_to = c("trans", "height"),
    values_to = "ss"
  ) %>% 
  mutate(
        trans = !is.na(trans), 
        height = as.integer(height)
  )
```

## Species
Figure 2. Contrasts from the nonparametric graphical tests of significance for
species. The species in columns are subtracted from the species in rows (e.g.
first column, second row is the aspen - balsam fir contrast). The grey envelope
displays the area of acceptance of the null hypothesis (no differences between
species, p<0.001) from the permutation of the residuals of the null model (eq.
2), the black curve is the average parameter difference (bolder when outside the
envelope). The diagonal displays the `r ifelse(plot_use_trans, "transformed ", "")`
vertical lidar return distribution of each species (on a different scale than
the contrasts): black lines represent the median species distribution, shaded
areas represent 95% and 50% variation envelopes.

```{r species_contrasts}
# adapted from: https://www.tidyverse.org/blog/2020/03/dplyr-1-0-0-summarise/
quibble_wide <- function(x, q = c(0.025, 0.25, 0.5, 0.75, 0.975)) {
  tibble(x = quantile(x, q), q = q) %>% 
    pivot_wider(1, names_from = q, values_from = x)
}

# Create species figure
psp <- wave_long %>% 
  filter(trans == plot_use_trans) %>% 
  group_by(dominant_species, height) %>% 
  summarise(quibble_wide(ss)) %>% 
  mutate(height = height / m) %>% 
  ggplot(aes(x = height, group = dominant_species)) + 
  geom_ribbon(aes(ymin = `0.025`, ymax = `0.975`), fill = light_grey) + 
  geom_ribbon(aes(ymin = `0.25`, ymax = `0.75`), fill = dark_grey) +
  geom_line(aes(y = `0.5`), colour = "grey20") +
  scale_y_continuous("Scaled lidar return density (transformed)", breaks = c(0:2) / 10, expand = c(0, 0)) +
  scale_x_continuous("Scaled stand height", limits = c(0, 1), breaks = 1:2/2, expand = c(0, 0)) +
  facet_grid(~dominant_species) + 
  coord_flip(ylim = c(0, 0.30), xlim = c(0, 1))

# Create species contrasts and add species on the diagonal
pcsp <- my_plot_contrasts(res_flm_sp, m, full = TRUE, diag = TRUE, add = psp)

ggsave("figure/fig2-sp-combined.pdf", pcsp, device = "pdf", dpi = "retina", width = 234, height = 234, units = "mm")
ggsave("figure/fig2-sp-combined.svg", pcsp, device = "svg", dpi = "retina", width = 234, height = 234, units = "mm")
```

## Crown closure

Figure 3. Coefficients of the transformed vertical distribution of lidar returns
for crown closure. Black lines represent the median distribution, shaded areas
represent 95% and 50% variation envelope. Top right numbers in the panels
indicate the number of observations (stands).
```{r crown_closure}
label_cc <- function(d) paste0(d, "%")
pc_cc <- my_plot_continuous(res_flm_cc, m, main = "my main") + scale_y_continuous("Scaled density effect")

ggsave("figure/fig3-glm-cc.pdf", pc_cc, device = "pdf", dpi = "retina", width = 234 / 2, height = 234 / 2, units = "mm")
ggsave("figure/fig3-glm-cc.svg", pc_cc, device = "svg", dpi = "retina", width = 234 / 2, height = 234 / 2, units = "mm")
```

Figure 4. `r ifelse(plot_use_trans, "Transformed v", "V")`ertical distribution 
of lidar returns as a function of crown closure and species. Black lines
represent the median distribution, shaded areas represent 95% and 50% variation
envelope. Top right numbers in the panels indicate the number of observations
(stands).
```{r crown_closure_contrasts}
pcc <- wave_long %>% 
  filter(trans == plot_use_trans) %>% 
  group_by(dominant_species, height, crown_closure) %>% 
  summarise(quibble_wide(ss), .groups = "drop_last") %>% 
  mutate(height = height / m) %>% 
  ggplot(aes(x = height, group = interaction(dominant_species, crown_closure))) + 
  geom_ribbon(aes(ymin = `0.025`, ymax = `0.975`), fill = light_grey) + 
  geom_ribbon(aes(ymin = `0.25`, ymax = `0.75`), fill = dark_grey) +
  geom_line(aes(y = `0.5`), colour = "grey20") +
  geom_vline(aes(xintercept = 0)) +
  scale_x_continuous("Scaled height", limits = c(0, 1), breaks = 1:2/2, expand = c(0, 0)) +
  scale_y_continuous("Scaled lidar return density", breaks = c(0:2) / 10, expand = c(0, 0)) +
  facet_grid(dominant_species~label_cc(crown_closure)) +
  coord_flip(ylim = c(0, 0.25), xlim = c(0, 1)) +
  ( if(plot_use_trans) 
    # transformed data
    list(
      coord_flip(ylim = c(-0.1, 0.2), xlim = c(0, 1)),
      scale_y_continuous("Scaled lidar return density (transformed)", breaks = c(-2, 0, 2, 4, 6) / 10, expand = c(0, 0))
      )
  )
pcc

ggsave("figure/fig4-cc.pdf", pcc, device = "pdf", dpi = "retina", width = 234, height = 234, units = "mm")
ggsave("figure/fig4-cc.svg", pcc, device = "svg", dpi = "retina", width = 234, height = 234, units = "mm")
```

## Age
Figure 5. `r ifelse(plot_use_trans, "Transformed v", "V")`ertical distribution 
of lidar returns as a function of stand density and species. Black lines
represent the median distribution, shaded areas represent 95% and 50% variation
envelope. Top right numbers in the panels indicate the number of observations
(stands).
```{r age}
label_age <- function(x) paste(x, "yr")
# upgrade labels
attr(res_flm_age, "labels") <- label_age(attr(res_flm_age, "labels"))
page <- my_plot_continuous(res_flm_age, m) +
  coord_flip(ylim = c(-0.05, 0.15), expand = c(0, 0)) +
  scale_y_continuous("Scaled density difference", labels = c(-5, 0, 5, 10) / 100, breaks = c(-5, 0, 5, 10) / 100)

ggsave("figure/fig5-age.pdf", page, device = "pdf", dpi = "retina", width = 234, height = 234 / 2, units = "mm")
ggsave("figure/fig5-age.svg", page, device = "svg", dpi = "retina", width = 234, height = 234 / 2, units = "mm")
```

Figure 6. `r ifelse(plot_use_trans, "Transformed v", "V")`ertical distribution 
of lidar returns as a function of age groups and species. Black lines
represent the median distribution, shaded areas represent 95% and 50% variation
envelope. Top right numbers in the panels indicate the number of observations
(stands).
```{r crown_closure_contrasts}
page2 <- wave_long %>% 
  filter(trans == plot_use_trans) %>% 
  group_by(dominant_species, height, age_class) %>% 
  summarise(quibble_wide(ss), .groups = "drop_last") %>% 
  mutate(height = height / m) %>% 
  ggplot(aes(x = height, group = interaction(dominant_species, age_class))) + 
  geom_ribbon(aes(ymin = `0.025`, ymax = `0.975`), fill = light_grey) + 
  geom_ribbon(aes(ymin = `0.25`, ymax = `0.75`), fill = dark_grey) +
  geom_line(aes(y = `0.5`), colour = "grey20") +
  geom_vline(aes(xintercept = 0)) +
  facet_grid(dominant_species~label_age(age_class)) +
  # scale_x_continuous("Scaled height", limits = c(0, 1), breaks = 1:2/2, expand = c(0, 0)) +
  # scale_y_continuous("Scaled lidar return density", breaks = c(0:2) / 10, expand = c(0, 0)) +
  coord_flip(ylim = c(0, 0.25), xlim = c(0, 1)) +
  # ( if(plot_use_trans) 
  #   # transformed data
  #   list(
  #     coord_flip(ylim = c(-0.1, 0.2), xlim = c(0, 1)),
  #     scale_y_continuous("Scaled lidar return density (transformed)", breaks = c(-2, 0, 2, 4, 6) / 10, expand = c(0, 0))
  #     )
  # )
  NULL
page2

ggsave("figure/fig6-age2.pdf", page2, device = "pdf", dpi = "retina", width = 234, height = 234, units = "mm")
ggsave("figure/fig6-age2.svg", page2, device = "svg", dpi = "retina", width = 234, height = 234, units = "mm")
```


# Appendix

```{r}
cap <- paste(
  "Each line is an observation, the bold line is the median function",
  "of the group, the grey ribbon displays the 95% and 50% intervals.",
  "The number in the top right corner is the number of observations."
)

wl <- wave_long %>% filter(!trans) # use untransformed data
papu <- wl %>% 
  group_by(dominant_species, crown_closure, age_class, height) %>% 
  summarise(
    n = n(),
    median = median(ss),
    q25 = quantile(ss, probs = 25/100),
    q75 = quantile(ss, probs = 75/100),
    q025 = quantile(ss, probs = 2.5/100),
    q0975 = quantile(ss, probs = 97.5/100)
    ) %>% 
  ggplot(aes(x = height / m, y = median, group = interaction(dominant_species, crown_closure, age_class))) +
  coord_flip(ylim = c(0, 0.25)) +
  geom_line(data = wl, aes(y = ss, color = dominant_species, group = stand_id), show.legend = FALSE, size = 0.1, alpha = 0.4) +
  geom_line(aes(color = dominant_species), show.legend = FALSE) +
  geom_ribbon(aes(ymin = q025, ymax = q0975), fill = "#000000", alpha = 0.2) +
  geom_ribbon(aes(ymin = q25, ymax = q75), fill = "#000000", alpha = 0.2) +
  scale_y_continuous("Scaled lidar return density", breaks = c(0:2) / 10, expand = c(0, 0)) +
  scale_x_continuous("Scaled height", limits = c(0, 1), breaks = 1:2/2) +
  geom_text(data = wl %>% 
              distinct(dominant_species, crown_closure, age_class, stand_id) %>% 
              count(dominant_species, crown_closure, age_class), 
            aes(label = n), x = Inf, y = Inf, hjust = 1.5, vjust = 1.5, size = 2.5) +
  facet_grid(dominant_species + age_class ~ crown_closure) +
    labs(
    title = "Vertical distribution of lidar returns",
    subtitle = "Figure A-1", 
    caption = wrapper(cap, 80)
    )

wlt <- wave_long %>% filter(trans) # use untransformed data
papt <- wlt %>% 
  group_by(dominant_species, crown_closure, age_class, height) %>% 
  summarise(
    n = n(),
    median = median(ss),
    q25 = quantile(ss, probs = 25/100),
    q75 = quantile(ss, probs = 75/100),
    q025 = quantile(ss, probs = 2.5/100),
    q0975 = quantile(ss, probs = 97.5/100)
    ) %>% 
  ggplot(aes(x = height / m, y = median, group = interaction(dominant_species, crown_closure, age_class))) +
  coord_flip(ylim = c(0, 0.25)) +
  geom_line(data = wlt, aes(y = ss, color = dominant_species, group = stand_id), show.legend = FALSE, size = 0.1, alpha = 0.4) +
  geom_line(aes(color = dominant_species), show.legend = FALSE) +
  geom_ribbon(aes(ymin = q025, ymax = q0975), fill = "#000000", alpha = 0.2) +
  geom_ribbon(aes(ymin = q25, ymax = q75), fill = "#000000", alpha = 0.2) +
  scale_y_continuous("Scaled lidar return density (transformed)", breaks = c(0:2) / 10, expand = c(0, 0)) +
  scale_x_continuous("Scaled height", limits = c(0, 1), breaks = 1:2/2) +
  geom_text(data = wlt %>% 
              distinct(dominant_species, crown_closure, age_class, stand_id) %>% 
              count(dominant_species, crown_closure, age_class), 
            aes(label = n), x = Inf, y = Inf, hjust = 1.5, vjust = 1.5, size = 2.5) +
  facet_grid(dominant_species + age_class ~crown_closure) +
  labs(
    title = "Vertical distribution of lidar returns (transformed)",
    subtitle = "Figure A-2", 
    caption = wrapper(cap, 80)
    )

ggsave("figure/appendix-1.pdf", papu + theme_pub(10), width = 6, height = 22, units = "in")
ggsave("figure/appendix-2.pdf", papt + theme_pub(10), width = 6, height = 22, units = "in")
```

