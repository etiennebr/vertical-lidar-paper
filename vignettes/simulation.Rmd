---
title: "simulation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{simulation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
devtools::load_all(here::here("../vertical-lidar-paper"))
library(tidyverse)
library(GET)
```

# Simulate functional data for contrasts

## Basic functions

Create "basic" functions for `sp` group
```{r}
fn <- tibble(
  x = c(1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L, 10L, 1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L, 10L), 
  y = c(1, 13, 224, 699, 620, 471, 174, 77, 15, 2, 5, 4, 8, 6, 13, 305, 458, 272, 176, 2) / 1000,
  sp = c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2)
)

#' Create the age function
fn_covariate <- tibble(
  x = 1:10,
  age_fn = c(1, 1, 5, 8, 12, 8, 6, 2, 1, 1) / 10
)

#' ## Simulation
#' Create 100 samples
set.seed(2020)
N <- 5000
probs_sp <- c(1, 2)
probs_age <- c(1, 2)
nperm <- 1000  # number of permutations
alpha <- 0.05
  
covariates <- tibble(
  id = seq_len(N),
  sp = sample(c(1, 2), N, replace = TRUE, prob = probs_sp),
  age = sample(0:1, N, replace = TRUE, prob = probs_age)
)

Y <- covariates %>% 
  left_join(fn, by = "sp") %>% 
  left_join(fn_covariate, by = "x") %>% 
  mutate(
    # determinist formula ---------------------
    y_det = y + age * age_fn,
    # add lognormal error ---------------------
    y_sto = y_det + rnorm(length(y_det), 0, sd = 0.2 + 0.3 * age + 0.2 * sp)
    )
```

Have a look at a subsample of the simulated data:
```{r}
Y %>% 
  # sample_by_group
  group_by(id) %>% 
  nest() %>% 
  ungroup() %>% 
  slice_sample(n = 20) %>% 
  unnest(data) %>% 
  ggplot(aes(x, y_sto, group = id, color = interaction(sp, age))) +
  geom_path() +
  coord_flip() + 
  facet_wrap(~id) +
  theme_void()
```

The deterministic basis for the functions
```{r}
detcon <- bind_rows(
  fn %>% mutate(
    effect = paste("sp", sp)
  ) %>% 
    select(-sp),
  fn_covariate %>% mutate(
    y = age_fn,
    effect = paste("age", 1)
  ) %>% 
    select(-age_fn)
)

```

The three deterministic functions for reference
```{r}
ggplot(detcon, aes(x, y, color = effect)) +
  geom_path() +
  coord_flip()
```


```{r}
#' ## Functional glm
Y_pivot <- Y %>% 
  pivot_wider(
    c(id, sp, age), 
    values_from = y_sto, 
    names_from = x, 
    names_prefix = "n"
  ) %>% 
  mutate(
    sp = factor(sp),
    age = factor(age)
  ) 

independent_factors <- Y_pivot %>% as.data.frame()

Y_matrix <- Y_pivot %>% 
  select(-(id:age)) %>% 
  as.matrix

cset <- create_curve_set(list(r = 1:10, obs = t(Y_matrix)))

res_var <- functional_anova(independent_factors$sp, contrasts = FALSE, curve_set = cset)
my_plot_contrasts(res_var, 10)

res_sp <- graph.flm(
  nsim = nperm, 
  formula.full = Y ~ sp + age,
  formula.reduced = Y ~ sp,
  curve_sets = cset, 
  factors = independent_factors,
  contrasts = TRUE
)

res_age <- graph.flm(
  nsim = nperm, 
  formula.full = Y ~ sp + age,
  formula.reduced = Y ~ age,
  curve_sets = cset, 
  factors = independent_factors,
  contrasts = TRUE
)

plot(res_sp) + coord_flip()
plot(res_age) + coord_flip()
```

# Apply transformation
```{r}
cset_trans <- corrUnequalVar(cset, groups=with(independent_factors, sp))
res_var_trans <-list(
  sp = functional_anova(independent_factors$sp, contrasts = FALSE, curve_set = cset_trans),
  age = functional_anova(independent_factors$age, contrasts = FALSE, curve_set = cset_trans)
)

(my_plot_contrasts(res_var_trans$sp, 10) + labs(title = "sp")) + 
  (my_plot_contrasts(res_var_trans$age, 10) + labs(title = "age"))
```

The first transformation removes the heteroscedasticity by species, but
heteroscedasticity remains by age.

```{r}
cset_trans_2 <- corrUnequalVar(cset_trans, groups=with(independent_factors, age))
res_var_trans_2 <-list(
  sp = functional_anova(independent_factors$sp, contrasts = FALSE, curve_set = cset_trans_2),
  age = functional_anova(independent_factors$age, contrasts = FALSE, curve_set = cset_trans_2)
)

(my_plot_contrasts(res_var_trans_2$sp, 10) + labs(title = "sp")) + 
  (my_plot_contrasts(res_var_trans_2$age, 10) + labs(title = "age"))
```

Applying the second transformation introduces heterogeneity back in the `sp`,
but removes what was remaining in `age`.

What happens when we compare the functions
```{r}
res_sp_trans <- graph.flm(
  nsim = nperm, 
  formula.full = Y ~ sp + age,
  formula.reduced = Y ~ sp,
  curve_sets = cset_trans_2, 
  factors = independent_factors,
  contrasts = TRUE
)

res_age_trans <- graph.flm(
  nsim = nperm, 
  formula.full = Y ~ sp + age,
  formula.reduced = Y ~ age,
  curve_sets = cset_trans_2, 
  factors = independent_factors,
  contrasts = TRUE
)

plot(res_sp_trans) + coord_flip()
plot(res_age_trans) + coord_flip()
```

